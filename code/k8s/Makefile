# ä¸»æœºå
HOST_NAME := k8smaster
# masterèŠ‚ç‚¹åå­—
MASTER_NAME := k8smaster
# node1èŠ‚ç‚¹åå­—
NODE_NAME := k8snode1
# masterèŠ‚ç‚¹IP
MASTER_IP := 10.211.55.30
# node1èŠ‚ç‚¹IP
NODE_IP := 10.211.55.31
# HOSTæ–‡ä»¶
HOST_CONF := /etc/hosts
# K8S CONF
K8S_CONF := /etc/sysctl.d/k8s.conf
# Dokcer ç‰ˆæœ¬å·
DOCKER_VERSION := 20.10.8
# Docker Daemonæ–‡ä»¶
DOCKER_DAEMON := /etc/docker/daemon.json
# K8S Yum è½¯ä»¶æºä½ç½®
K8S_YUM_REGISTRY := /etc/yum.repos.d/kubernetes.repo
# K8S Version
K8S_VERSION := 1.21.1
# USER æ–‡ä»¶æ‰€æœ‰è€…
FILE_USER := $(shell id -u)
# GROUP æ–‡ä»¶æ‰€æœ‰ç»„
FILE_GROUP := $(shell id -g)
# æ·»åŠ æ‰§è¡Œæƒé™
ADD_EXEC_MODE := $(shell touch ip.sh && chmod u+x ip.sh)
# å½“å‰ç›®å½•ç»å¯¹è·¯å¾„
CURRENT_DIR := $(shell pwd)

#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 1.å…³é—­é˜²ç«å¢™ï¼ˆåœæ­¢å¹¶ç¦ç”¨ï¼‰
.PHONY: disabled_firewalld
disabled_firewalld:
	# ä¸´æ—¶å…³é—­firewalld 
	systemctl stop firewalld
	# æ°¸ä¹…å…³é—­firewalld
	systemctl disable firewalld
	echo 'ğŸ‰Successfully disabled firewalld!'
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 2.å…³é—­selinux
.PHONY: disabled_selinux
disabled_selinux:
	# ä¸´æ—¶å…³é—­selinux
	setenforce 0 
	# æ°¸ä¹…å…³é—­selinux
	sed -i 's/enforcing/disabled/' /etc/selinux/config
	echo 'ğŸ‰Successfully disabled selinux!' 
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------# 
# 3.å…³é—­swapåˆ†åŒº
.PHONY: disabled_swap
disabled_swap:
	# ä¸´æ—¶å…³é—­swap
	swapoff -a 
	# æ°¸ä¹…å…³é—­swap
	sed -ri 's/.*swap.*/#&/' /etc/fstab
	echo 'ğŸ‰Successfully disabled swap!'
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 4.è®¾ç½®ä¸»æœºå
.PHONY: set_hostname
set_hostname:
	hostnamectl set-hostname $(HOST_NAME)
	echo "ğŸ‰Successfully set hostname to |$(HOST_NAME)|"
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 5.åœ¨masterä¸Šæ·»åŠ hosts
.PHONY: set_hosts
set_hosts:
	# é…ç½®masterèŠ‚ç‚¹host
	echo $(MASTER_IP) $(MASTER_NAME) >> $(HOST_CONF)
	# é…ç½®node1èŠ‚ç‚¹host
	echo $(NODE_IP) $(NODE_NAME) >> $(HOST_CONF)
	echo "ğŸ‰Successfully set hosts \
	|$(MASTER_IP) $(MASTER_NAME)| \
	$(NODE_IP) $(NODE_NAME)| \
	to |$(HOST_CONF)| "
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 6.å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾
.PHONY: set_iptables
set_iptables:
	echo net.bridge.bridge-nf-call-ip6tables = 1 >> $(K8S_CONF)
	echo net.bridge.bridge-nf-call-iptables = 1 >> $(K8S_CONF)
	# ç”Ÿæ•ˆ
	sysctl --system
	echo "ğŸ‰Successfully set iptables!"
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 7.æ—¶é—´åŒæ­¥
.PHONY: sync_time
sync_time:
	yum -y install chrony
	sed -i "/pool 2.centos.pool.ntp.org iburst/iserver ntp.aliyun.com iburst" /etc/chrony.conf
	systemctl enable chronyd
	systemctl restart chronyd
	echo "ğŸ‰Successfully sync time!"
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 8.å®‰è£…Docker
.PHONY: install_docker
install_docker:
	wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
	yum -y install docker-ce-$(DOCKER_VERSION)
	docker --version
	echo "ğŸ‰Successfully install docker!"
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 9.å¯åŠ¨Docker
.PHONY: start_docker
start_docker:
	systemctl enable docker
	systemctl start docker
	docker --version
	echo "ğŸ‰Successfully start docker!"
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 10.é…ç½®Dockeré•œåƒæº
.PHONY: set_image_registry
set_image_registry:
	echo {  >> $(DOCKER_DAEMON)
	echo '  "registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]' >> $(DOCKER_DAEMON)
	echo } >> $(DOCKER_DAEMON)
	systemctl restart docker
	docker --version
	echo "ğŸ‰Successfully set image registry!"
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 11.é…ç½®æ·»åŠ kubernetes yumè½¯ä»¶æº
.PHONY: set_k8s_yum_registry
set_k8s_yum_registry:
	echo '[kubernetes]' >> $(K8S_YUM_REGISTRY)
	echo 'name=Kubernetes' >> $(K8S_YUM_REGISTRY)
	echo 'baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64' >> $(K8S_YUM_REGISTRY)
	echo 'enabled=1' >> $(K8S_YUM_REGISTRY)
	echo 'gpgcheck=0' >> $(K8S_YUM_REGISTRY)
	echo 'repo_gpgcheck=0' >> $(K8S_YUM_REGISTRY)
	echo 'gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg' >> $(K8S_YUM_REGISTRY)
	echo "ğŸ‰Successfully set k8s yum registry!"
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 12.å®‰è£…kubeadmï¼Œkubeletå’Œkubectl
.PHONY: install_k8s_core
install_k8s_core:
	yum install -y kubelet-$(K8S_VERSION) kubeadm-$(K8S_VERSION) kubectl-$(K8S_VERSION)
	# è®¾ç½®å¼€æœºå¯åŠ¨
	systemctl enable kubelet
	echo "ğŸ‰Successfully install k8s core!"
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 13.éƒ¨ç½²K8S MasterèŠ‚ç‚¹ã€æ³¨æ„ï¼šä»…åœ¨MasterèŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‘
.PHONY: init_master
init_master:
	# å› ä¸ºé˜¿é‡Œäº‘æ²¡æœ‰å¯¹åº”çš„â€™registry.aliyuncs.com/google_containers/coredns/coredns:v1.8.0â€˜
	# æ‰€ä»¥æœªåœå…ˆçŸ¥ï¼Œæå‰ä¸‹è½½å¥½å¯¹åº”é•œåƒï¼Œæ”¹tag
	docker pull registry.aliyuncs.com/google_containers/coredns:1.8.0
	docker tag registry.aliyuncs.com/google_containers/coredns:1.8.0 registry.aliyuncs.com/google_containers/coredns:1.8.0
	kubeadm init \
	--apiserver-advertise-address=$(MASTER_IP) \
	--image-repository registry.aliyuncs.com/google_containers \
	--kubernetes-version $(K8S_VERSION) \
	--service-cidr=10.96.0.0/12 \
	--pod-network-cidr=10.244.0.0/16
#------------------------------------------------------------------------------------------------------------------------------#	
#------------------------------------------------------------------------------------------------------------------------------#
# 14.å¯åŠ¨kubectlçš„ä½¿ç”¨ã€æ³¨æ„ï¼šä»…åœ¨MasterèŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‘ 
.PHONY: start_use_kubectl
start_use_kubectl:
	mkdir -p $(HOME)/.kube
	cp -i /etc/kubernetes/admin.conf $(HOME)/.kube/config
	chown $(FILE_USER):$(FILE_GROUP) $(HOME)/.kube/config
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 15.MasterèŠ‚ç‚¹ä¸Šç”ŸæˆToken
.PHONY: create_token
create_token:
	kubeadm token create --print-join-command
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 16.åˆ°Nodeä¸­æ‰§è¡Œç¬¬15æ­¥ç”Ÿæˆçš„å‘½ä»¤
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 17.éƒ¨ç½²CNIç½‘ç»œæ’ä»¶
.PHONY: install_flannel
install_flannel:
	kubectl apply -f $(CURRENT_DIR)/packages/kube-flannel/kube-flannel.yaml
	kubectl get pods -n kube-system
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 18.æµ‹è¯•é›†ç¾¤éƒ¨ç½²ã€æ³¨æ„ï¼šä»…åœ¨MasterèŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‘
.PHONY: test_k8s
test_k8s:
	rm -f ip.sh
	kubectl create deployment nginx --image=nginx
	sleep 20
	$(ADD_EXEC_MODE)
	kubectl get pod -o wide | awk '{if(NR>1){print $$6}}' >> ip.sh
	sed -i "s/\(.*\)/curl \1/" ip.sh
	sh ip.sh && rm -f ip.sh 
	kubectl delete deployment nginx
	echo "ğŸ‰Successfully Test K8S!"
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 19.å®‰è£…Helm
.PHONY: install_helm
install_helm:
	chmod u+x $(CURRENT_DIR)/packages/helm/install-helm3.sh
	ls -lah $(CURRENT_DIR)/packages/helm
	sh $(CURRENT_DIR)/packages/helm/install-helm3.sh
	helm version
	echo 'ğŸ‰Successfully Install Helm!'
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# 20.æ·»åŠ Helmä»“åº“æº
.PHONY: add_helm_registry
add_helm_registry:
	helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
	helm repo update
	helm repo list
	echo 'ğŸ‰Successfully add helm registry!'
#------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------------------------------------------------------------------------------------------#
# ä¸€é”®å®‰è£…æ ¸å¿ƒæ­¥éª¤ï¼ˆ1~12ï¼‰
.PHONY: install
install: disabled_firewalld disabled_selinux disabled_swap set_hosts set_iptables sync_time install_docker start_docker set_image_registry set_k8s_yum_registry install_k8s_core
#------------------------------------------------------------------------------------------------------------------------------#
